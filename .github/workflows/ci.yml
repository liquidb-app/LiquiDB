name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: TypeScript type check (Electron)
        run: npm run electron:compile -- --noEmit

      - name: TypeScript type check (Main)
        run: npx tsc --noEmit

      - name: TypeScript type check (Preload)
        run: npx tsc -p tsconfig.preload.json --noEmit

      - name: TypeScript type check (Helper)
        run: npx tsc -p tsconfig.helper.json --noEmit

  check-conflicts:
    name: Check for Conflicts
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Check for merge conflicts
        run: |
          git merge-tree $(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }}) HEAD origin/${{ github.event.pull_request.base.ref }} > /tmp/merge-result.txt || true
          if grep -q "<<<<<<< " /tmp/merge-result.txt; then
            echo "❌ Merge conflicts detected!"
            echo "Please resolve conflicts before merging."
            exit 1
          else
            echo "✅ No merge conflicts detected"
          fi

  validate-commit-messages:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # Get commits in this push
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.event.after }}"
            
            # Get all commit messages in the push
            COMMITS=$(git log ${BASE_SHA}..${HEAD_SHA} --pretty=format:"%s")
            
            if [ -z "$COMMITS" ]; then
              echo "No commits found in push"
              exit 0
            fi
            
            echo "Validating commit messages..."
            INVALID_COUNT=0
            echo "$COMMITS" | while IFS= read -r commit_msg; do
              # Check if commit message follows Conventional Commits format
              if echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?(!)?:"; then
                echo "✅ Valid: $commit_msg"
              elif echo "$commit_msg" | grep -qE "(BREAKING CHANGE|BREAKING:)"; then
                echo "✅ Valid (breaking change): $commit_msg"
              elif echo "$commit_msg" | grep -qE "^Merge "; then
                echo "ℹ️  Merge commit: $commit_msg"
              elif echo "$commit_msg" | grep -qE "^Bump version"; then
                echo "ℹ️  Version bump commit: $commit_msg"
              else
                echo "⚠️  Warning: Commit message doesn't follow Conventional Commits format:"
                echo "   $commit_msg"
                INVALID_COUNT=$((INVALID_COUNT + 1))
              fi
            done
            
            if [ $INVALID_COUNT -gt 0 ]; then
              echo "⚠️  Found $INVALID_COUNT commit(s) that don't follow Conventional Commits format"
              echo "   This is a warning, not an error. Consider using: type(scope): description"
            fi
          else
            echo "Initial commit, skipping validation"
          fi

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Compile Electron code
        run: |
          npm run electron:compile
          npm run preload:build
          npm run helper:build

      - name: Build Next.js
        run: npm run build

