name: Version

on:
  push:
    branches:
      - main

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.release_status.outputs.new_release_published }}
      new_release_version: ${{ steps.release_status.outputs.new_release_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT }}
          ref: main
          fetch-tags: true

      - name: Fetch all tags and refs
        run: |
          git config --global --add safe.directory '*'
          git fetch origin --tags --force || true
          git fetch origin --force || true
          echo "All tags:"
          git tag -l | sort -V || echo "No tags found"
          echo ""
          echo "Tag refs:"
          git show-ref --tags 2>/dev/null || echo "No tag refs found"

      - name: Check latest tag and current commit
        id: check_tag
        continue-on-error: true
        run: |
          set +e
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "Current commit: $CURRENT_COMMIT"
          
          # Get the latest version tag
          LATEST_TAG=$(git tag -l 'v*.*.*' | sort -V | tail -n 1 || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "Latest tag: $LATEST_TAG"
            LATEST_TAG_COMMIT=$(git rev-list -n 1 "$LATEST_TAG" 2>/dev/null || echo "")
            echo "Latest tag commit: $LATEST_TAG_COMMIT"
          else
            echo "No version tags found"
          fi
          
          # Check if current commit already has a tag
          EXISTING_TAG=$(git tag --points-at HEAD 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || echo "")
          if [ -n "$EXISTING_TAG" ]; then
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            echo "existing_tag=$EXISTING_TAG" >> $GITHUB_OUTPUT
            echo "Current commit already has tag: $EXISTING_TAG"
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
            echo "No existing tag found for this commit"
          fi
          
          # Check commits since latest tag
          if [ -n "$LATEST_TAG" ] && [ -n "$LATEST_TAG_COMMIT" ]; then
            COMMITS_SINCE_TAG=$(git rev-list --count "$LATEST_TAG_COMMIT..HEAD" 2>/dev/null || echo "0")
            echo "Commits since $LATEST_TAG: $COMMITS_SINCE_TAG"
          fi
          set -e

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Generate package-lock.json if missing
        run: |
          if [ ! -f package-lock.json ]; then
            echo "package-lock.json not found, generating..."
            npm install --package-lock-only
          fi

      - name: Install dependencies
        run: npm ci

      - name: Verify tags are visible to semantic-release
        if: steps.check_tag.outputs.tag_exists != 'true'
        run: |
          echo "Tags visible to git:"
          git tag -l | sort -V || echo "No tags found"
          echo ""
          echo "Tag refs:"
          git show-ref --tags 2>/dev/null || echo "No tag refs found"
          echo ""
          echo "Latest tag details:"
          LATEST_TAG=$(git tag -l 'v*.*.*' | sort -V | tail -n 1 || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "Latest tag: $LATEST_TAG"
            git show-ref --tags 2>/dev/null | grep "$LATEST_TAG" || echo "Tag $LATEST_TAG not found in refs"
            git log --oneline -1 "$LATEST_TAG" 2>/dev/null || echo "Cannot show commit for tag $LATEST_TAG"
            echo ""
            echo "Commits since $LATEST_TAG:"
            git log --oneline "$LATEST_TAG..HEAD" | head -20 || echo "No commits since tag"
          else
            echo "No version tags found"
          fi
          echo ""
          echo "Current package.json version:"
          grep '"version"' package.json || echo "No version found in package.json"
          echo ""
          echo "Git remote info:"
          git remote -v
          echo ""
          echo "Git branch info:"
          git branch -a

      - name: Ensure tags are available for semantic-release
        if: steps.check_tag.outputs.tag_exists != 'true'
        run: |
          # Ensure all tags are fetched and visible
          git fetch origin --tags --force
          # Verify semantic-release can see tags
          LATEST_TAG=$(git tag -l 'v*.*.*' | sort -V | tail -n 1 || echo "")
          if [ -n "$LATEST_TAG" ]; then
            echo "Latest tag found: $LATEST_TAG"
            TAG_COMMIT=$(git rev-list -n 1 "$LATEST_TAG" 2>/dev/null || echo "")
            CURRENT_COMMIT=$(git rev-parse HEAD)
            echo "Tag commit: $TAG_COMMIT"
            echo "Current commit: $CURRENT_COMMIT"
            COMMITS_SINCE=$(git rev-list --count "$LATEST_TAG..HEAD" 2>/dev/null || echo "0")
            echo "Commits since tag: $COMMITS_SINCE"
            
            # Check if the tag exists on the current commit
            if [ "$TAG_COMMIT" = "$CURRENT_COMMIT" ]; then
              echo "Tag $LATEST_TAG already exists on current commit - semantic-release will skip"
              echo "skip_release=true" >> $GITHUB_ENV
            else
              echo "Tag $LATEST_TAG exists on different commit - semantic-release will increment"
              echo "skip_release=false" >> $GITHUB_ENV
            fi
          else
            echo "No version tags found - semantic-release will create v1.0.0"
            echo "skip_release=false" >> $GITHUB_ENV
          fi
          
          # Verify tags are visible to git
          echo ""
          echo "All tags visible to git:"
          git tag -l | sort -V || echo "No tags found"

      - name: Check if release should be skipped
        if: steps.check_tag.outputs.tag_exists != 'true'
        id: should_skip
        run: |
          SKIP_RELEASE="${{ env.skip_release }}"
          if [ "$SKIP_RELEASE" == "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping semantic-release - tag already exists on current commit"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Running semantic-release - will increment from existing tag"
          fi

      - name: Run semantic-release
        id: semantic
        if: steps.check_tag.outputs.tag_exists != 'true' && (steps.should_skip.outputs.skip != 'true' || steps.should_skip.outputs.skip == '')
        uses: cycjimmy/semantic-release-action@v4
        with:
          semantic_version: 23
          extra_plugins: |
            @semantic-release/changelog@6.0.3
            @semantic-release/git@10.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME: github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com

      - name: Set release status outputs
        id: release_status
        run: |
          if [ "${{ steps.check_tag.outputs.tag_exists }}" == "true" ]; then
            echo "new_release_published=false" >> $GITHUB_OUTPUT
            echo "new_release_version=${{ steps.check_tag.outputs.existing_tag }}" >> $GITHUB_OUTPUT
            echo "Skipping release - tag ${{ steps.check_tag.outputs.existing_tag }} already exists for this commit"
          else
            # Use semantic-release outputs if available, otherwise default to false
            NEW_RELEASE_PUBLISHED="${{ steps.semantic.outputs.new_release_published }}"
            NEW_RELEASE_VERSION="${{ steps.semantic.outputs.new_release_version }}"
            if [ -z "$NEW_RELEASE_PUBLISHED" ]; then
              NEW_RELEASE_PUBLISHED="false"
            fi
            if [ -z "$NEW_RELEASE_VERSION" ]; then
              NEW_RELEASE_VERSION=""
            fi
            echo "new_release_published=$NEW_RELEASE_PUBLISHED" >> $GITHUB_OUTPUT
            echo "new_release_version=$NEW_RELEASE_VERSION" >> $GITHUB_OUTPUT
          fi

