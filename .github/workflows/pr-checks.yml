name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit messages
        run: |
          # Get commits in PR
          if [ "${{ github.event.pull_request.base.sha }}" != "" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            
            # Get all commit messages in the PR
            COMMITS=$(git log ${BASE_SHA}..${HEAD_SHA} --pretty=format:"%s")
            
            if [ -z "$COMMITS" ]; then
              echo "No commits found in PR"
              exit 0
            fi
            
            echo "Validating commit messages..."
            echo "$COMMITS" | while IFS= read -r commit_msg; do
              # Check if commit message follows Conventional Commits format
              # Format: type(scope): description
              # Types: feat, fix, docs, style, refactor, perf, test, chore, etc.
              # Also allow: BREAKING CHANGE, BREAKING:, or type!:
              
              if echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?(!)?:"; then
                echo "✅ Valid: $commit_msg"
              elif echo "$commit_msg" | grep -qE "(BREAKING CHANGE|BREAKING:)"; then
                echo "✅ Valid (breaking change): $commit_msg"
              elif echo "$commit_msg" | grep -qE "^Merge "; then
                echo "ℹ️  Merge commit: $commit_msg"
              elif echo "$commit_msg" | grep -qE "^Bump version"; then
                echo "ℹ️  Version bump commit: $commit_msg"
              else
                echo "⚠️  Warning: Commit message doesn't follow Conventional Commits format:"
                echo "   $commit_msg"
                echo "   Expected format: type(scope): description"
                echo "   Example: feat: add new feature"
                echo "   Example: fix: resolve bug"
                echo "   Example: feat!: breaking change"
              fi
            done
          else
            echo "Could not determine base SHA, skipping commit validation"
          fi

  check-conflicts:
    name: Check for Merge Conflicts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
      
      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
      
      - name: Check for merge conflicts
        run: |
          git merge-tree $(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }}) HEAD origin/${{ github.event.pull_request.base.ref }} > /tmp/merge-result.txt || true
          if grep -q "<<<<<<< " /tmp/merge-result.txt; then
            echo "❌ Merge conflicts detected!"
            echo "Please resolve conflicts before merging."
            exit 1
          else
            echo "✅ No merge conflicts detected"
          fi

  lint-and-typecheck:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: TypeScript type check
        run: |
          npm run electron:compile -- --noEmit
          npx tsc --noEmit

  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Compile Electron code
        run: |
          npm run electron:compile
          npm run preload:build
          npm run helper:build
      
      - name: Build Next.js
        run: npm run build

