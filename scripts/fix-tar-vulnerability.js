#!/usr/bin/env node

/**
 * Fix tar vulnerability by updating the bundled tar package in npm
 * This script updates tar from 7.5.1 to 7.5.2+ to fix CVE-2024-58047
 */

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');
const os = require('os');

const tarPath = path.join(__dirname, '..', 'node_modules', 'npm', 'node_modules', 'tar');
const packageJsonPath = path.join(tarPath, 'package.json');

if (fs.existsSync(tarPath)) {
  try {

    const packageJson = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));
    

    if (packageJson.version === '7.5.1') {
      console.log('Updating bundled tar package from 7.5.1 to 7.5.2+ to fix vulnerability...');
      

      const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'tar-update-'));
      
      try {
        // Download tar 7.5.2 using npm pack
        execSync('npm pack tar@7.5.2', {
          cwd: tempDir,
          stdio: 'pipe'
        });
        

        const packedFiles = fs.readdirSync(tempDir).filter(f => f.endsWith('.tgz'));
        if (packedFiles.length === 0) {
          throw new Error('Failed to download tar package');
        }
        
        const packedFile = path.join(tempDir, packedFiles[0]);
        

        execSync(`tar -xzf "${packedFile}"`, {
          cwd: tempDir,
          stdio: 'pipe'
        });
        

        const extractedDir = fs.readdirSync(tempDir).find(f => 
          fs.statSync(path.join(tempDir, f)).isDirectory() && f.startsWith('package')
        );
        
        if (!extractedDir) {
          throw new Error('Failed to extract tar package');
        }
        
        const sourcePath = path.join(tempDir, extractedDir);
        

        const filesToKeep = ['node_modules'];
        const files = fs.readdirSync(tarPath);
        for (const file of files) {
          if (!filesToKeep.includes(file)) {
            const filePath = path.join(tarPath, file);
            const stat = fs.statSync(filePath);
            if (stat.isDirectory()) {
              fs.rmSync(filePath, { recursive: true, force: true });
            } else {
              fs.unlinkSync(filePath);
            }
          }
        }
        

        const sourceFiles = fs.readdirSync(sourcePath);
        for (const file of sourceFiles) {
          const sourceFile = path.join(sourcePath, file);
          const destFile = path.join(tarPath, file);
          const stat = fs.statSync(sourceFile);
          if (stat.isDirectory()) {
            fs.cpSync(sourceFile, destFile, { recursive: true });
          } else {
            fs.copyFileSync(sourceFile, destFile);
          }
        }
        
        console.log('✓ Successfully updated tar package to 7.5.2+');
      } finally {

        fs.rmSync(tempDir, { recursive: true, force: true });
      }
    } else {
      console.log(`ℹ tar package is already at version ${packageJson.version}, skipping update`);
    }
  } catch (error) {
    console.warn('⚠ Warning: Could not update bundled tar package:', error.message);
    // Don't fail the build if this fails
    process.exit(0);
  }
} else {
  console.log('ℹ npm bundled tar not found, skipping update');
}

